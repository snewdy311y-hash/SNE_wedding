<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner - Penerimaan Tamu</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#4a90d9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        :root {
            --primary: #4a90d9;
            --primary-dark: #3a7bc8;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --gray: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            min-height: 100vh;
        }
        
        /* Login Screen */
        .login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-screen.hidden {
            display: none;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .login-card h1 {
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .login-card p {
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        .login-card input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            margin-bottom: 20px;
        }
        
        .login-card input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .login-card button {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .login-card button:hover {
            background: var(--primary-dark);
        }
        
        .login-error {
            color: var(--danger);
            margin-top: 15px;
            display: none;
        }
        
        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.2rem;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.3s;
        }
        
        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: 0.3s;
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-btn i {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Scanner Section */
        .scanner-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        #qr-reader {
            width: 100%;
        }
        
        #qr-reader video {
            width: 100% !important;
            border-radius: 15px 15px 0 0;
        }
        
        .scanner-controls {
            padding: 20px;
            display: flex;
            gap: 10px;
        }
        
        .scan-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .scan-btn.primary {
            background: var(--primary);
            color: white;
        }
        
        .scan-btn.secondary {
            background: #e0e0e0;
            color: var(--dark);
        }
        
        /* Manual Input */
        .manual-input {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .manual-input h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            text-transform: uppercase;
        }
        
        .input-group button {
            padding: 15px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        /* Guest Card */
        .guest-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-top: 20px;
            display: none;
        }
        
        .guest-card.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .guest-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .guest-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .guest-category {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .guest-category.vip {
            background: #fff3cd;
            color: #856404;
        }
        
        .guest-category.reguler {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .guest-category.keluarga {
            background: #d4edda;
            color: #155724;
        }
        
        .guest-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .info-item {
            background: var(--light);
            padding: 15px;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: 600;
            color: var(--dark);
        }
        
        .info-value.status-success {
            color: var(--success);
        }
        
        .info-value.status-warning {
            color: var(--warning);
        }
        
        .guest-actions {
            display: flex;
            gap: 15px;
        }
        
        .action-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .action-btn.checkin {
            background: var(--success);
            color: white;
        }
        
        .action-btn.suvenir {
            background: var(--warning);
            color: var(--dark);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Guest List */
        .search-box {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .guest-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .guest-list-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: 0.3s;
        }
        
        .guest-list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .guest-list-info h4 {
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .guest-list-info p {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .guest-list-status {
            display: flex;
            gap: 5px;
        }
        
        .status-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .status-badge.done {
            background: var(--success);
            color: white;
        }
        
        .status-badge.pending {
            background: #e0e0e0;
            color: var(--gray);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            opacity: 0;
            transition: 0.3s;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .modal-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .modal-icon.success { color: var(--success); }
        .modal-icon.warning { color: var(--warning); }
        
        .modal h3 {
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .modal p {
            color: var(--gray);
            margin-bottom: 25px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .modal-btn.confirm {
            background: var(--primary);
            color: white;
        }
        
        .modal-btn.cancel {
            background: #e0e0e0;
            color: var(--dark);
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .guest-info {
                grid-template-columns: 1fr;
            }
            
            .guest-actions {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-card">
            <h1><i class="fas fa-qrcode"></i> Scanner</h1>
            <p>Masukkan password admin untuk mengakses sistem penerimaan tamu</p>
            <input type="password" id="login-password" placeholder="Password Admin">
            <button onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Masuk
            </button>
            <p class="login-error" id="login-error">Password salah!</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-qrcode"></i> Scanner Tamu</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="header-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <button class="tab-btn active" onclick="showTab('scan')">
                <i class="fas fa-camera"></i>
                Scan
            </button>
            <button class="tab-btn" onclick="showTab('list')">
                <i class="fas fa-list"></i>
                Daftar
            </button>
            <button class="tab-btn" onclick="showTab('stats')">
                <i class="fas fa-chart-bar"></i>
                Statistik
            </button>
        </nav>

        <!-- SCAN TAB -->
        <div class="tab-content active" id="tab-scan">
            <!-- QR Scanner -->
            <div class="scanner-container">
                <div id="qr-reader"></div>
                <div class="scanner-controls">
                    <button class="scan-btn primary" id="start-scan-btn" onclick="startScanner()">
                        <i class="fas fa-camera"></i> Mulai Scan
                    </button>
                    <button class="scan-btn secondary" id="stop-scan-btn" onclick="stopScanner()" style="display:none;">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                </div>
            </div>

            <!-- Manual Input -->
            <div class="manual-input">
                <h3><i class="fas fa-keyboard"></i> Input Manual</h3>
                <div class="input-group">
                    <input type="text" id="manual-code" placeholder="Masukkan kode tamu" maxlength="10">
                    <button onclick="searchByCode()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <!-- Guest Card -->
            <div class="guest-card" id="guest-card">
                <div class="guest-header">
                    <div>
                        <h2 class="guest-name" id="guest-name">-</h2>
                        <small id="guest-code" style="color: var(--gray);">-</small>
                    </div>
                    <span class="guest-category" id="guest-category">-</span>
                </div>
                
                <div class="guest-info">
                    <div class="info-item">
                        <div class="info-label">Jumlah Kursi</div>
                        <div class="info-value" id="guest-seats">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status RSVP</div>
                        <div class="info-value" id="guest-rsvp">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Status Check-in</div>
                        <div class="info-value" id="guest-checkin">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Suvenir</div>
                        <div class="info-value" id="guest-suvenir">-</div>
                    </div>
                </div>
                
                <div class="guest-actions">
                    <button class="action-btn checkin" id="btn-checkin" onclick="handleCheckin()">
                        <i class="fas fa-check"></i> Check-in
                    </button>
                    <button class="action-btn suvenir" id="btn-suvenir" onclick="handleSuvenir()">
                        <i class="fas fa-gift"></i> Suvenir
                    </button>
                </div>
            </div>
        </div>

        <!-- LIST TAB -->
        <div class="tab-content" id="tab-list">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Cari nama tamu..." oninput="filterGuests()">
            </div>
            <div class="guest-list" id="guest-list">
                <!-- Guest items will be populated here -->
            </div>
        </div>

        <!-- STATS TAB -->
        <div class="tab-content" id="tab-stats">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="stat-total">0</div>
                    <div class="stat-label">Total Undangan</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-rsvp">0</div>
                    <div class="stat-label">RSVP Hadir</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-checkin">0</div>
                    <div class="stat-label">Sudah Check-in</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-suvenir">0</div>
                    <div class="stat-label">Suvenir Diambil</div>
                </div>
            </div>
            
            <div class="stat-card" style="margin-bottom: 15px;">
                <h4 style="margin-bottom: 15px; color: var(--dark);">Breakdown Kategori</h4>
                <div id="category-breakdown"></div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirm-modal">
        <div class="modal-content">
            <div class="modal-icon" id="modal-icon">
                <i class="fas fa-question-circle"></i>
            </div>
            <h3 id="modal-title">Konfirmasi</h3>
            <p id="modal-message">Apakah Anda yakin?</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal()">Batal</button>
                <button class="modal-btn confirm" id="modal-confirm-btn">Ya</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // CONFIGURATION - GANTI DENGAN URL WEB APP ANDA
        // =============================================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwDTfIkvWGVxpgKJY7DvaeJakKT2Stmiy3ekRSjRkwLUjpK-vBOfIBgrVf0b13I_ND2/exec';
        
        // =============================================================================
        // GLOBAL STATE
        // =============================================================================
        let adminPassword = '';
        let allGuests = [];
        let currentGuest = null;
        let html5QrCode = null;
        let isScanning = false;
        
        // =============================================================================
        // API FUNCTIONS
        // =============================================================================
        // Pakai GET untuk semua panggilan ke Apps Script agar tidak kena CORS preflight (POST diblokir dari GitHub Pages)
        async function apiCall(action, method = 'GET', data = null) {
            try {
                let url = `${API_URL}?action=${action}`;
                const options = { method: 'GET' };
                if (data) {
                    Object.keys(data).forEach(key => {
                        url += `&${key}=${encodeURIComponent(data[key] || '')}`;
                    });
                }
                const response = await fetch(url, options);
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: error.message };
            }
        }
        
        // =============================================================================
        // LOGIN
        // =============================================================================
        async function handleLogin() {
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            
            const result = await apiCall('verifyAdmin', 'GET', { password });
            
            if (result.success) {
                adminPassword = password;
                localStorage.setItem('adminPassword', password);
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').style.display = 'block';
                loadAllData();
            } else {
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 3000);
            }
        }
        
        function logout() {
            adminPassword = '';
            localStorage.removeItem('adminPassword');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').style.display = 'none';
        }
        
        // Auto-login if password saved
        window.onload = function() {
            const savedPassword = localStorage.getItem('adminPassword');
            if (savedPassword) {
                document.getElementById('login-password').value = savedPassword;
                handleLogin();
            }
        };
        
        // =============================================================================
        // DATA LOADING
        // =============================================================================
        async function loadAllData() {
            showToast('Memuat data...', 'info');
            
            // Load guests
            const guestsResult = await apiCall('getAllGuests', 'GET', { password: adminPassword });
            if (guestsResult.success) {
                allGuests = guestsResult.data;
                renderGuestList();
            }
            
            // Load stats
            const statsResult = await apiCall('getDashboard', 'GET', { password: adminPassword });
            if (statsResult.success) {
                updateStats(statsResult.data);
            }
            
            showToast('Data berhasil dimuat', 'success');
        }
        
        function refreshData() {
            loadAllData();
        }
        
        // =============================================================================
        // QR SCANNER
        // =============================================================================
        function startScanner() {
            const qrReader = document.getElementById('qr-reader');
            
            html5QrCode = new Html5Qrcode('qr-reader');
            
            html5QrCode.start(
                { facingMode: 'environment' },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanFailure
            ).then(() => {
                isScanning = true;
                document.getElementById('start-scan-btn').style.display = 'none';
                document.getElementById('stop-scan-btn').style.display = 'block';
            }).catch(err => {
                showToast('Gagal mengakses kamera: ' + err, 'error');
            });
        }
        
        function stopScanner() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    document.getElementById('start-scan-btn').style.display = 'block';
                    document.getElementById('stop-scan-btn').style.display = 'none';
                });
            }
        }
        
        function onScanSuccess(decodedText) {
            // Extract code from URL or use as-is
            let code = decodedText;
            
            // If it's a URL, extract the code parameter
            if (decodedText.includes('?')) {
                const url = new URL(decodedText);
                code = url.searchParams.get('code') || url.searchParams.get('c') || decodedText;
            }
            
            // Vibrate for feedback
            if (navigator.vibrate) {
                navigator.vibrate(200);
            }
            
            // Search guest
            searchGuest(code);
            
            // Stop scanner temporarily
            stopScanner();
        }
        
        function onScanFailure(error) {
            // Ignore scan failures (no QR found in frame)
        }
        
        // =============================================================================
        // GUEST SEARCH & DISPLAY
        // =============================================================================
        function searchByCode() {
            const code = document.getElementById('manual-code').value.trim().toUpperCase();
            if (code) {
                searchGuest(code);
            }
        }
        
        function searchGuest(code) {
            const guest = allGuests.find(g => g.uniqueCode === code);
            
            if (guest) {
                currentGuest = guest;
                displayGuest(guest);
            } else {
                showToast('Tamu dengan kode ' + code + ' tidak ditemukan', 'error');
                hideGuestCard();
            }
        }
        
        function displayGuest(guest) {
            document.getElementById('guest-name').textContent = guest.nama;
            document.getElementById('guest-code').textContent = guest.uniqueCode;
            document.getElementById('guest-seats').textContent = guest.jumlahKursi + ' orang';
            
            // Category badge
            const categoryEl = document.getElementById('guest-category');
            categoryEl.textContent = guest.kategori || 'Reguler';
            categoryEl.className = 'guest-category ' + (guest.kategori || 'reguler').toLowerCase();
            
            // RSVP status
            const rsvpEl = document.getElementById('guest-rsvp');
            rsvpEl.textContent = guest.statusRsvp || 'Belum';
            rsvpEl.className = 'info-value' + (guest.statusRsvp === 'Hadir' ? ' status-success' : '');
            
            // Check-in status
            const checkinEl = document.getElementById('guest-checkin');
            checkinEl.textContent = guest.statusCheckin || 'Belum';
            checkinEl.className = 'info-value' + (guest.statusCheckin === 'Sudah' ? ' status-success' : '');
            
            // Suvenir status
            const suvenirEl = document.getElementById('guest-suvenir');
            suvenirEl.textContent = guest.suvenirDiambil || 'Belum';
            suvenirEl.className = 'info-value' + (guest.suvenirDiambil === 'Sudah' ? ' status-success' : '');
            
            // Update button states
            const btnCheckin = document.getElementById('btn-checkin');
            const btnSuvenir = document.getElementById('btn-suvenir');
            
            btnCheckin.disabled = guest.statusCheckin === 'Sudah';
            btnSuvenir.disabled = guest.suvenirDiambil === 'Sudah';
            
            if (guest.statusCheckin === 'Sudah') {
                btnCheckin.innerHTML = '<i class="fas fa-check-double"></i> Sudah Check-in';
            } else {
                btnCheckin.innerHTML = '<i class="fas fa-check"></i> Check-in';
            }
            
            if (guest.suvenirDiambil === 'Sudah') {
                btnSuvenir.innerHTML = '<i class="fas fa-check-double"></i> Sudah Diambil';
            } else {
                btnSuvenir.innerHTML = '<i class="fas fa-gift"></i> Suvenir';
            }
            
            // Show card
            document.getElementById('guest-card').classList.add('show');
        }
        
        function hideGuestCard() {
            document.getElementById('guest-card').classList.remove('show');
            currentGuest = null;
        }
        
        // =============================================================================
        // CHECK-IN & SUVENIR
        // =============================================================================
        function handleCheckin() {
            if (!currentGuest) return;
            
            showModal(
                'Check-in Tamu?',
                `Konfirmasi check-in untuk <strong>${currentGuest.nama}</strong>?`,
                'success',
                async () => {
                    const result = await apiCall('checkIn', 'GET', {
                        code: currentGuest.uniqueCode,
                        password: adminPassword
                    });
                    
                    if (result.success) {
                        showToast('Check-in berhasil!', 'success');
                        currentGuest.statusCheckin = 'Sudah';
                        displayGuest(currentGuest);
                        updateLocalGuest(currentGuest);
                        refreshData();
                    } else {
                        showToast(result.error || 'Gagal check-in', 'error');
                    }
                    closeModal();
                }
            );
        }
        
        function handleSuvenir() {
            if (!currentGuest) return;
            
            showModal(
                'Berikan Suvenir?',
                `Berikan suvenir <strong>${currentGuest.kategori || 'Reguler'}</strong> untuk <strong>${currentGuest.nama}</strong>?`,
                'warning',
                async () => {
                    const result = await apiCall('giveSouvenir', 'GET', {
                        code: currentGuest.uniqueCode,
                        password: adminPassword
                    });
                    
                    if (result.success) {
                        showToast('Suvenir berhasil diberikan!', 'success');
                        currentGuest.suvenirDiambil = 'Sudah';
                        displayGuest(currentGuest);
                        updateLocalGuest(currentGuest);
                        refreshData();
                    } else {
                        showToast(result.error || 'Gagal memberikan suvenir', 'error');
                    }
                    closeModal();
                }
            );
        }
        
        function updateLocalGuest(guest) {
            const index = allGuests.findIndex(g => g.uniqueCode === guest.uniqueCode);
            if (index >= 0) {
                allGuests[index] = guest;
                renderGuestList();
            }
        }
        
        // =============================================================================
        // GUEST LIST
        // =============================================================================
        function renderGuestList() {
            const container = document.getElementById('guest-list');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = allGuests;
            if (searchTerm) {
                filtered = allGuests.filter(g => 
                    g.nama.toLowerCase().includes(searchTerm) ||
                    g.uniqueCode.toLowerCase().includes(searchTerm)
                );
            }
            
            container.innerHTML = filtered.map(guest => `
                <div class="guest-list-item" onclick="selectGuest('${guest.uniqueCode}')">
                    <div class="guest-list-info">
                        <h4>${guest.nama}</h4>
                        <p>${guest.uniqueCode} | ${guest.kategori || 'Reguler'}</p>
                    </div>
                    <div class="guest-list-status">
                        <div class="status-badge ${guest.statusCheckin === 'Sudah' ? 'done' : 'pending'}" title="Check-in">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="status-badge ${guest.suvenirDiambil === 'Sudah' ? 'done' : 'pending'}" title="Suvenir">
                            <i class="fas fa-gift"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function filterGuests() {
            renderGuestList();
        }
        
        function selectGuest(code) {
            searchGuest(code);
            showTab('scan');
        }
        
        // =============================================================================
        // STATISTICS
        // =============================================================================
        function updateStats(stats) {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-rsvp').textContent = stats.rsvp.hadir;
            document.getElementById('stat-checkin').textContent = stats.checkin.sudah;
            document.getElementById('stat-suvenir').textContent = stats.suvenir.sudah;
            
            // Category breakdown
            const breakdown = document.getElementById('category-breakdown');
            breakdown.innerHTML = `
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <strong>VIP</strong><br>
                        ${stats.kategori.vip.checkin}/${stats.kategori.vip.total}
                    </div>
                    <div>
                        <strong>Reguler</strong><br>
                        ${stats.kategori.reguler.checkin}/${stats.kategori.reguler.total}
                    </div>
                    <div>
                        <strong>Keluarga</strong><br>
                        ${stats.kategori.keluarga.checkin}/${stats.kategori.keluarga.total}
                    </div>
                </div>
            `;
        }
        
        // =============================================================================
        // UI HELPERS
        // =============================================================================
        function showTab(tabId) {
            // Update nav buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
        }
        
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showModal(title, message, type, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            
            const icon = document.getElementById('modal-icon');
            icon.className = 'modal-icon ' + type;
            icon.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>`;
            
            document.getElementById('modal-confirm-btn').onclick = onConfirm;
            
            modal.classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('confirm-modal').classList.remove('show');
        }
        
        // Enter key for manual input
        document.getElementById('manual-code')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchByCode();
        });
        
        document.getElementById('login-password')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });
    </script>
</body>
</html>
